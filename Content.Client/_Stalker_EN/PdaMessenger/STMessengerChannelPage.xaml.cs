using System.Numerics;
using Content.Shared._Stalker_EN.PdaMessenger;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._Stalker_EN.PdaMessenger;

/// <summary>
/// Channel/DM conversation page showing messages and compose/reply controls.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class STMessengerChannelPage : BoxContainer
{
    /// <summary>Raised when the user presses the back button to return to the main page.</summary>
    public event Action? OnBack;

    /// <summary>Raised when the user presses compose; arg is the current chat ID.</summary>
    public event Action<string>? OnCompose;

    /// <summary>Raised when the user presses reply on a message; args are (chatId, messageId, snippet).</summary>
    public event Action<string, uint, string>? OnReply;

    private string _chatId = string.Empty;
    private string _lastChatId = string.Empty;
    private int _lastMessageCount;

    public STMessengerChannelPage()
    {
        RobustXamlLoader.Load(this);

        BackButton.OnPressed += _ => OnBack?.Invoke();
        ComposeButton.OnPressed += _ => OnCompose?.Invoke(_chatId);
    }

    public void SetChatId(string chatId)
    {
        _chatId = chatId;
    }

    public void UpdateState(STMessengerChat chat)
    {
        ChatTitle.Text = chat.DisplayName;

        // Full rebuild only if chat changed or messages were reset
        if (chat.Id != _lastChatId || chat.Messages.Count < _lastMessageCount)
        {
            MessageList.RemoveAllChildren();
            _lastMessageCount = 0;
            _lastChatId = chat.Id;
        }

        // Append only new messages
        for (var i = _lastMessageCount; i < chat.Messages.Count; i++)
        {
            var entry = new STMessengerMessageEntry(chat.Messages[i]);
            entry.OnReply += (msgId, snippet) => OnReply?.Invoke(_chatId, msgId, snippet);
            MessageList.AddChild(entry);
        }

        _lastMessageCount = chat.Messages.Count;
        MessageScroll.SetScrollValue(new Vector2(0, float.MaxValue));
    }
}
